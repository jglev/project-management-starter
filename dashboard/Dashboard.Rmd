---
title: "Dissertation Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(dplyr)
library(DT)
library(flexdashboard)
library(ggplot2)
library(lubridate)
library(timevis)
```

```{r parse data, include=FALSE}
raw_text <- readLines(file.path("..", "ProjectNotes.md"))

# Create a blank dataframe, which we'll fill in below:
parsed_data <- data.frame(
  group=character(),
  content=character(), 
  start=character(), 
  end=character(),
  style=character(),
  stringsAsFactors=FALSE
)

# Loop though the todo file's lines, and find and parse the todo lines within it:
# See the ?timevis documentation to understand the column names and
# values that are used below:
for (line in raw_text) {
  line_data <- data.frame(
    group=character(),
    content=character(), 
    start=character(), 
    end=character(),
    style=character(),
    stringsAsFactors=FALSE
  )
  
  status_marker_regex <- "\\s*- \\[(.)\\].*"
  status_marker <- gsub(status_marker_regex, "\\1", line, perl = TRUE)
  
  # If no match was found above, status_marker will be the same as line. In that case, we
  # can consider this not to be a todo line:
  if (status_marker == line) {
    next 
  }
  
  if (status_marker == " ") {
    line_data[1, "group"] <- "TODO" 
  } else if (status_marker == "/") {
    line_data[1, "group"] <- "RIGHT NOW" 
  } else if (status_marker == "x" || status_marker == "X") {
    line_data[1, "group"] <- "DONE" 
  } else if (status_marker == "V" || status_marker == "v") {
    line_data[1, "group"] <- "DONE" 
  } else if (status_marker == ">") {
    line_data[1, "group"] <- "SCHEDULED" 
  } else if (status_marker == "<") {
    line_data[1, "group"] <- "MIGRATED" 
  } else if (status_marker == "-") {
    line_data[1, "group"] <- "CANCELLED" 
  } else if (status_marker == "O") {
    line_data[1, "group"] <- "BLOCKED" 
  }
    
  description <- gsub(
    paste0(status_marker_regex, "? (.*?)((\\s*|$)(SCHEDULED|DUE)).*"),
    "\\2", 
    line, 
    perl = TRUE
  )
  
  if (description != line) {
    line_data[1, "content"] <- description
  }
  
  scheduled <- gsub(".* SCHEDULED: (.*?)(\\s|$).*", "\\1", line, perl = TRUE)
  if (scheduled != line) {
    line_data[1, "start"] <- scheduled
  }
  
  due <- gsub(".* DUE: (.*?)(\\s|$).*", "\\1", line, perl = TRUE)
  if (due != line) {
    line_data[1, "end"] <- due
  }
  
  if (!is.na(line_data[1, "start"]) && is.na(line_data[1, "end"])) {
    line_data[1, "style"] <- "color: black; background: white; border-bottom: .5em solid darkturquoise"
  } else if (is.na(line_data[1, "start"]) && !is.na(line_data[1, "end"])) {
    # timevis requires every charted line to have a 'start' value. In this
    # case, we will call the Due date the "start", but will mark it with a different
    # color:
    line_data[1, "start"] <- line_data[1, "end"]
    line_data[1, "end"] <- NA
    line_data[1, "style"] <- "color: black; background: white; border-bottom: .5em solid deeppink"
  } else {
    # If both start and end are set:
    line_data[1, "style"] <- "color: black; background: white; border: .5em solid;
  border-image-source: linear-gradient(to right, darkturquoise, deeppink); border-image-slice: 1; border-top:0; border-left:0; border-right:0;"
  }
  
  if (!is.na(line_data[1, "start"]) || !is.na(line_data[1, "end"])) {
    parsed_data <- rbind(parsed_data, line_data)
  }
}
```

Column {data-width=650}
-----------------------------------------------------------------------

### Gantt Chart

```{r}
parsed_data %>% 
  filter(
    !is.na(start)
  ) %>% 
  timevis(
    groups = tribble(
      ~id,          ~content,     ~style,
      "TODO",       "TODO",       "color: #FF0000", 
      "RIGHT NOW",  "RIGHT NOW",  "color: #0000FF",
      "SCHEDULED",  "SCHEDULED",  "color: #0000FF",
      "MIGRATED",   "MIGRATED",   "color: #9370D8",
      "BLOCKED",    "BLOCKED",    "color: #FFA500",
      "CANCELLED",  "CANCELLED",  "color: #82d882",
      "DONE",       "DONE",       "color: #90EE90",
    )
  )
```

Column {data-width=350}
-----------------------------------------------------------------------

### Status Breakdown

```{r}
ggplot(parsed_data, aes(
  factor(group, levels = c(
    "TODO",
    "RIGHT NOW",
    "SCHEDULED",
    "MIGRATED",
    "CANCELLED",
    "BLOCKED",
    "DONE"
  )), 
  fill = factor(group)
)) + 
  xlab("Status") + 
  ylab("Count") +
  geom_bar() + 
  theme_classic() +
  scale_fill_manual(values = c(
    "TODO" = "#FF0000", 
    "RIGHT NOW" = "#0000FF",
    "SCHEDULED" = "#0000FF",
    "MIGRATED" = "#9370D8",
    "CANCELLED" = "#82d882",
    "BLOCKED" = "#FFA500",
    "DONE" = "#90EE90"
  )) + 
   theme(
     legend.position = "none",
     text = element_text(size=20)
   )
```

### Scheduled Tasks

```{r}
datatable(
  parsed_data %>% 
    filter(
      ymd(start) <= Sys.Date() & 
      group != "DONE"
    ) %>% 
    rename(
      Status = group,
      Description = content,
      Scheduled = start,
      Due = end
    ),
  options = list(pageLength = 5)
)
```


### Due and Overdue Tasks


```{r}
datatable(
  parsed_data %>% 
    filter(
      ymd(end) >= Sys.Date() & 
      group != "DONE"
    ) %>% 
    rename(
      Status = group,
      Description = content,
      Scheduled = start,
      Due = end
    ),
  options = list(pageLength = 5)
)
```
